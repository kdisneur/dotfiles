#! /bin/sh

source ~/.togglrc

BASE_URL=https://www.toggl.com/api/v8

start() {
  description="$1"
  curl -s -u ${API_TOKEN}:api_token \
       -H "Content-Type: application/json" \
       -X POST ${BASE_URL}/time_entries/start \
       -d "{\"time_entry\":{\"description\":\"${description}\",\"pid\":${DEFAULT_PROJECT_ID},\"created_with\":\"CLI\"}}"
}

stop() {
  id=$(current_entry_id)

  curl -s -u ${API_TOKEN}:api_token \
    -H "Content-Type: application/json" \
    -X PUT ${BASE_URL}/time_entries/${id}/stop
}

current() {
  current_entry | sed -E 's/.*description":\w*"([^"]+).*/\1/'
}

current_entry_id() {
  current_entry | sed -E 's/.*"id":\w*([0-9]+).*/\1/g'
}

current_entry() {
  curl -s -u ${API_TOKEN}:api_token \
       -X GET ${BASE_URL}/time_entries/current
}

case "$1" in
  current)
    current
    ;;
  start)
    start "$2"
    ;;
  stop)
    stop
    ;;
esac

